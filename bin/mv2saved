#!/usr/bin/perl
#
# Move all files recognized as datafiles from /data/ftp to /data/save/$year/$doy
# Must be same filesystem

use strict;
use warnings;

my $SAVEDIR = "/data/saved";
my $dest;

open(my $pd, "find /data/ftp -type f -print |") || die("Cannot execute find");

while (<$pd>) {
  chomp;
  my $fn = substr($_, 10);   # strip /data/ftp/ from filename
  undef $dest;
  study $fn;
  if ($fn =~ /^([A-Z0-9]{4})[0-9]{3}[a-z]+\.([0-9]{2})o\.zip$/) {
    $dest = "$1/20$2";
  }
  elsif ($fn =~ /^([A-Z0-9a-z]{4})([0-9]{4})[0-9]{8}B\.zip$/) {
    $dest = "$1/$2";
  }
  elsif ($fn =~ /^([A-Z0-9a-z]{4})[0-9A-Z]{5}_R_([0-9]{4})[0-9]{7}_/) {
    $dest = "$1/$2";
  }
  elsif ($fn =~ /^([A-Z0-9]{4})[0-9]{3}[a-z]+\.([0-9]{2})_$/i) {
    $dest = "$1/20$2";
  }

  next unless defined $dest;
  $dest = "$SAVEDIR/$dest";
  system("mkdir -p $dest") unless -d $dest;
  rename($_, "$dest/$fn");
}

close($pd);
